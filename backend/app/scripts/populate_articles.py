#!/usr/bin/env python3
"""
Скрипт для заполнения базы данных фейковыми статьями для блога
"""

import sys
import os
from pathlib import Path
from datetime import datetime, timedelta
import random

# Добавляем корневую директорию в путь
sys.path.append(str(Path(__file__).parent.parent))

from sqlalchemy.orm import Session
from core.database import SessionLocal, engine
from models.article import Article
from models.base import Base

# Создаем таблицы если их нет
Base.metadata.create_all(bind=engine)

# Фейковые данные статей
FAKE_ARTICLES = [
    {
        "title": "Введение в 3D печать: с чего начать новичку",
        "slug": "introduction-to-3d-printing-for-beginners",
        "excerpt": "Полное руководство для тех, кто только начинает свой путь в мире 3D печати. Узнайте о типах принтеров, материалах и первых шагах.",
        "content": """# Введение в 3D печать: с чего начать новичку

3D печать — это революционная технология, которая позволяет создавать физические объекты из цифровых моделей. Если вы только начинаете свой путь в этой увлекательной области, это руководство поможет вам сделать первые шаги.

## Что такое 3D печать?

3D печать, также известная как аддитивное производство, — это процесс создания трёхмерных объектов путём послойного нанесения материала. В отличие от традиционных методов производства, которые удаляют материал (субтрактивное производство), 3D печать добавляет материал слой за слоем.

## Типы 3D принтеров

### FDM (Fused Deposition Modeling)
- **Принцип работы**: Расплавленный пластик выдавливается через сопло
- **Материалы**: PLA, ABS, PETG, TPU
- **Преимущества**: Доступная цена, простота использования
- **Недостатки**: Видимые слои, ограниченная детализация

### SLA (Stereolithography)
- **Принцип работы**: Жидкая смола отверждается ультрафиолетовым светом
- **Материалы**: Фотополимерные смолы
- **Преимущества**: Высокая детализация, гладкая поверхность
- **Недостатки**: Токсичные материалы, необходимость постобработки

## Выбор первого принтера

При выборе первого 3D принтера учитывайте:

1. **Бюджет** — FDM принтеры начального уровня стоят от 15,000 рублей
2. **Размер печати** — определите максимальный размер объектов
3. **Простота использования** — ищите принтеры с автокалибровкой
4. **Сообщество** — выбирайте популярные модели с хорошей поддержкой

## Заключение

3D печать открывает безграничные возможности для творчества и прототипирования. Начните с простого FDM принтера, изучите основы и постепенно развивайте свои навыки. Помните: каждый эксперт когда-то был новичком!

**Удачи в вашем 3D путешествии!**""",
        "category": "Обучение",
        "featured_image": "/static/images/articles/3d-printing-intro.jpg",
        "tags": ["новичкам", "основы", "FDM", "выбор-принтера", "руководство"],
        "is_published": True
    },
    {
        "title": "PLA vs ABS vs PETG: какой пластик выбрать?",
        "slug": "pla-vs-abs-vs-petg-material-comparison",
        "excerpt": "Подробное сравнение самых популярных материалов для 3D печати. Узнайте преимущества и недостатки каждого типа пластика.",
        "content": """# PLA vs ABS vs PETG: какой пластик выбрать?

Выбор правильного материала — один из ключевых факторов успешной 3D печати. В этой статье мы подробно рассмотрим три самых популярных типа пластика и поможем вам сделать правильный выбор.

## PLA (Polylactic Acid)

### Характеристики
- **Температура печати**: 190-220°C
- **Температура стола**: 50-60°C (опционально)
- **Усадка**: Минимальная
- **Запах**: Сладковатый, приятный

### Преимущества
- ✅ Легко печатается
- ✅ Биоразлагаемый
- ✅ Широкая цветовая палитра
- ✅ Не требует подогрева стола
- ✅ Минимальная деформация

### Недостатки
- ❌ Низкая термостойкость (60°C)
- ❌ Хрупкость
- ❌ Плохая химическая стойкость
- ❌ Не подходит для функциональных деталей

## ABS (Acrylonitrile Butadiene Styrene)

### Характеристики
- **Температура печати**: 220-250°C
- **Температура стола**: 80-100°C
- **Усадка**: Значительная
- **Запах**: Резкий, требует вентиляции

### Преимущества
- ✅ Высокая прочность
- ✅ Термостойкость до 100°C
- ✅ Химическая стойкость
- ✅ Возможность постобработки ацетоном
- ✅ Ударопрочность

### Недостатки
- ❌ Сложность печати
- ❌ Требует подогрев стола
- ❌ Деформация и растрескивание
- ❌ Токсичные пары
- ❌ Плохая адгезия к столу

## PETG (Polyethylene Terephthalate Glycol)

### Характеристики
- **Температура печати**: 220-250°C
- **Температура стола**: 70-80°C
- **Усадка**: Минимальная
- **Запах**: Отсутствует

### Преимущества
- ✅ Легкость печати как у PLA
- ✅ Прочность как у ABS
- ✅ Химическая стойкость
- ✅ Прозрачность
- ✅ Пищевая безопасность
- ✅ Хорошая адгезия слоёв

### Недостатки
- ❌ Высокая цена
- ❌ Склонность к перегреву
- ❌ Сложность удаления поддержек
- ❌ Царапается легче чем ABS

## Заключение

Каждый материал имеет свои преимущества и области применения. PLA идеален для начинающих, ABS — для функциональных деталей, PETG — универсальный выбор. Экспериментируйте и находите оптимальные решения для ваших проектов!""",
        "category": "Материалы",
        "featured_image": "/static/images/articles/materials-comparison.jpg",
        "tags": ["материалы", "PLA", "ABS", "PETG", "сравнение", "выбор"],
        "is_published": True
    },
    {
        "title": "Настройка слайсера: оптимальные параметры печати",
        "slug": "slicer-settings-optimal-print-parameters",
        "excerpt": "Подробное руководство по настройке слайсера для получения качественных отпечатков. Разбираем каждый параметр и его влияние на результат.",
        "content": """# Настройка слайсера: оптимальные параметры печати

Слайсер — это программа, которая преобразует 3D модель в инструкции для принтера. Правильная настройка слайсера критически важна для получения качественных отпечатков.

## Основные параметры

### Высота слоя (Layer Height)
**Диапазон**: 0.1-0.3 мм
**Рекомендации**:
- 0.1-0.15 мм — высокое качество, медленная печать
- 0.2 мм — оптимальный баланс
- 0.25-0.3 мм — быстрая печать, видимые слои

### Скорость печати (Print Speed)
**PLA**: 40-60 мм/с
**ABS**: 30-50 мм/с
**PETG**: 30-45 мм/с

## Температурные настройки

### Температура сопла
- PLA: 200-220°C
- ABS: 230-250°C
- PETG: 230-250°C
- TPU: 210-230°C

### Температура стола
- PLA: 50-60°C (опционально)
- ABS: 80-100°C
- PETG: 70-80°C
- TPU: 40-50°C

## Заполнение (Infill)

### Процент заполнения
- **10-15%** — декоративные изделия
- **20-25%** — обычные детали
- **30-50%** — функциональные части
- **80-100%** — максимальная прочность

## Заключение

Настройка слайсера — это искусство, требующее практики и экспериментов. Начните с базовых настроек и постепенно их оптимизируйте под ваши конкретные задачи и материалы.

**Помните**: лучшие настройки — те, которые работают именно для вашего принтера и материалов!""",
        "category": "Технологии",
        "featured_image": "/static/images/articles/slicer-settings.jpg",
        "tags": ["слайсер", "настройки", "параметры", "качество", "оптимизация"],
        "is_published": True
    },
    {
        "title": "Постобработка 3D печатных изделий: от шлифовки до покраски",
        "slug": "3d-print-post-processing-guide",
        "excerpt": "Полное руководство по постобработке 3D печатных изделий. Узнайте как превратить сырой отпечаток в профессиональное изделие.",
        "content": """# Постобработка 3D печатных изделий: от шлифовки до покраски

Постобработка — это процесс улучшения внешнего вида и свойств 3D печатных изделий. Правильная постобработка может превратить любительский отпечаток в профессиональное изделие.

## Подготовка к постобработке

### Инструменты и материалы
- Наждачная бумага (120-3000 грит)
- Надфили и шлифовальные блоки
- Ацетон (для ABS)
- Изопропиловый спирт
- Грунтовка и краски
- Кисти и аэрограф
- Защитные средства

### Безопасность
- Работайте в проветриваемом помещении
- Используйте респиратор и перчатки
- Защищайте глаза при шлифовке
- Храните химикаты в безопасном месте

## Механическая обработка

### Удаление поддержек
1. **Грубое удаление** — кусачками или ножом
2. **Точная обработка** — надфилями
3. **Финишная шлифовка** — мелкой наждачкой

### Шлифовка

#### Этапы шлифовки:
1. **Грубая (120-220 грит)** — удаление слоёв
2. **Средняя (400-800 грит)** — сглаживание
3. **Финишная (1000-3000 грит)** — полировка

## Грунтовка и покраска

### Выбор грунтовки
- **Универсальная** — для большинства пластиков
- **Адгезионная** — для сложных поверхностей
- **Заполняющая** — скрывает мелкие дефекты

### Покраска

#### Типы красок:
- **Акриловые** — безопасные, быстросохнущие
- **Эмалевые** — прочные, глянцевые
- **Специальные** — металлик, флуоресцентные

## Заключение

Постобработка требует терпения и практики, но результат того стоит. Начните с простых техник и постепенно осваивайте более сложные методы. Каждый проект — это возможность улучшить свои навыки!

**Помните**: хорошая постобработка может спасти даже неидеальный отпечаток!""",
        "category": "Технологии",
        "featured_image": "/static/images/articles/post-processing.jpg",
        "tags": ["постобработка", "шлифовка", "покраска", "финиш", "качество"],
        "is_published": True
    },
    {
        "title": "Решение проблем 3D печати: диагностика и устранение дефектов",
        "slug": "3d-printing-troubleshooting-guide",
        "excerpt": "Исчерпывающее руководство по диагностике и устранению самых распространённых проблем 3D печати. Превратите неудачи в успехи!",
        "content": """# Решение проблем 3D печати: диагностика и устранение дефектов

3D печать — это процесс, который требует точной настройки множества параметров. Даже опытные пользователи сталкиваются с различными проблемами. В этом руководстве мы разберём самые частые дефекты и способы их устранения.

## Проблемы адгезии первого слоя

### Симптомы:
- Модель не прилипает к столу
- Углы отклеиваются (warping)
- Неравномерный первый слой

### Причины и решения:

#### 1. Неправильная калибровка стола
**Диагностика**: Неравномерная толщина первого слоя
**Решение**:
1. Выполните автокалибровку (если есть)
2. Ручная калибровка по 4 углам + центр
3. Используйте щуп или лист бумаги
4. Проверьте уровень стола индикатором

#### 2. Неподходящая температура стола
**Диагностика**: Модель отклеивается во время печати
**Решение**:
- PLA: 50-60°C (или без подогрева)
- ABS: 80-100°C
- PETG: 70-80°C
- TPU: 40-50°C

## Дефекты поверхности

### Стринги (Stringing)

#### Симптомы:
- Тонкие нити между частями модели
- "Паутина" на отпечатке

#### Решения:
- Увеличьте ретракт
- Снизьте температуру
- Увеличьте скорость перемещений

### Слоновья нога (Elephant's foot)

#### Симптомы:
- Расширенный первый слой
- Неточные размеры внизу

#### Решения:
1. **Снизьте температуру стола**
2. **Увеличьте охлаждение первого слоя**
3. **Используйте фаску в модели**
4. **Настройте компенсацию в слайсере**

## Заключение

Решение проблем 3D печати — это навык, который развивается с опытом. Ведите журнал настроек и результатов, это поможет быстрее находить решения в будущем.

**Помните**: каждая проблема — это возможность лучше понять свой принтер и улучшить качество печати!""",
        "category": "Советы",
        "featured_image": "/static/images/articles/troubleshooting.jpg",
        "tags": ["проблемы", "диагностика", "решения", "дефекты", "качество"],
        "is_published": True
    },
    {
        "title": "Будущее 3D печати: новые технологии и материалы 2024",
        "slug": "future-of-3d-printing-2024-technologies",
        "excerpt": "Обзор самых перспективных технологий и материалов в области 3D печати. Узнайте, что нас ждёт в ближайшем будущем.",
        "content": """# Будущее 3D печати: новые технологии и материалы 2024

3D печать продолжает стремительно развиваться, открывая новые возможности в различных отраслях. В этой статье мы рассмотрим самые перспективные технологии и материалы, которые определят будущее аддитивного производства.

## Революционные технологии печати

### Continuous Liquid Interface Production (CLIP)

#### Принцип работы:
- Непрерывная полимеризация смолы
- Скорость в 25-100 раз выше традиционной SLA
- Отсутствие слоёв в структуре материала

#### Преимущества:
- ✅ Сверхвысокая скорость
- ✅ Гладкая поверхность
- ✅ Изотропные свойства материала
- ✅ Промышленные материалы

### Multi Jet Fusion (MJF)

#### Особенности:
- Высота слоя: 0.08 мм
- Скорость печати: очень высокая
- Материалы: PA12, PA11, TPU
- Точность: ±0.3 мм

#### Преимущества:
- Высокая производительность
- Отличные механические свойства
- Возможность многоцветной печати
- Переработка неиспользованного порошка

## Инновационные материалы

### Умные материалы

#### Shape Memory Polymers (SMP)
- Температура активации: 60°C
- Коэффициент восстановления: 95%
- Применение: медицинские стенты, самособирающиеся конструкции

#### 4D печать
- Материалы, изменяющие форму во времени
- Реакция на температуру, влажность, pH
- Самосборка и самовосстановление

### Биоматериалы

#### Биосовместимые полимеры
- **PEEK** — имплантаты позвоночника
- **PCL** — рассасывающиеся стенты
- **PLA медицинский** — временные имплантаты

## Промышленные применения

### Аэрокосмическая отрасль

#### Достижения 2024:
- Печать деталей двигателей
- Лёгкие конструкции с решётчатой структурой
- Быстрое прототипирование

### Медицина

#### Персонализированная медицина
- Имплантаты по индивидуальным размерам
- Протезы с идеальной посадкой
- Хирургические направляющие

#### Биопечать
- Печать живых тканей
- Органы на чипах
- Тестирование лекарств

## Заключение

Будущее 3D печати выглядит невероятно перспективным. Технологии развиваются экспоненциально, открывая новые возможности в каждой отрасли. Мы стоим на пороге эры, когда 3D печать станет такой же обыденной, как сегодня обычная печать на бумаге.

**Готовьтесь к революции в производстве!**""",
        "category": "Новости",
        "featured_image": "/static/images/articles/future-3d-printing.jpg",
        "tags": ["будущее", "технологии", "инновации", "материалы", "тренды"],
        "is_published": True
    }
]

# Авторы больше не нужны

def populate_articles():
    """Заполняет базу данных фейковыми статьями"""
    db: Session = SessionLocal()
    
    try:
        # Проверяем, есть ли уже статьи в базе
        existing_articles = db.query(Article).count()
        if existing_articles > 0:
            print(f"В базе уже есть {existing_articles} статей.")
            
            # Выводим статистику существующих статей
            published_articles = db.query(Article).filter(Article.is_published == True).count()
            
            print(f"\n📊 Текущая статистика:")
            print(f"   📝 Всего статей: {existing_articles}")
            print(f"   📰 Опубликованных: {published_articles}")
            
            # Статистика по категориям
            from sqlalchemy import func
            categories = db.query(Article.category, func.count(Article.id)).group_by(Article.category).all()
            
            print(f"\n📊 По категориям:")
            for category, count in categories:
                print(f"   {category}: {count}")
            
            print("\n✅ Статьи уже существуют в базе данных!")
            return
        
        print("Добавляем фейковые статьи...")
        
        for i, article_data in enumerate(FAKE_ARTICLES):
            # Устанавливаем дату публикации (последние 3 месяца)
            days_ago = random.randint(1, 90)
            published_at = datetime.now() - timedelta(days=days_ago)
            
            # Создаём статью
            article = Article(
                **article_data,
                published_at=published_at
            )
            db.add(article)
            
            print(f"✓ Добавлена статья: {article.title}")
        
        db.commit()
        
        # Выводим статистику
        total_articles = db.query(Article).count()
        published_articles = db.query(Article).filter(Article.is_published == True).count()
        
        print(f"\n🎉 Успешно добавлено:")
        print(f"   📝 Статей: {total_articles}")
        print(f"   📰 Опубликованных: {published_articles}")
        
        # Статистика по категориям
        print(f"\n📊 По категориям:")
        from sqlalchemy import func
        categories = db.query(Article.category, func.count(Article.id)).group_by(Article.category).all()
        
        for category, count in categories:
            print(f"   {category}: {count}")
            
    except Exception as e:
        print(f"❌ Ошибка при добавлении статей: {e}")
        db.rollback()
        raise
    finally:
        db.close()

if __name__ == "__main__":
    print("🚀 Запуск скрипта заполнения статей...")
    populate_articles()
    print("✅ Готово!")