# Prometheus alerting rules for NordLayer 3D Printing Platform

groups:
- name: nordlayer_system
  rules:
  - alert: HighCPUUsage
    expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High CPU usage detected"
      description: "CPU usage is above 80% for more than 5 minutes on {{ $labels.instance }}"

  - alert: CriticalCPUUsage
    expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 95
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "Critical CPU usage detected"
      description: "CPU usage is above 95% for more than 2 minutes on {{ $labels.instance }}"

  - alert: HighMemoryUsage
    expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100 > 85
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High memory usage detected"
      description: "Memory usage is above 85% for more than 5 minutes on {{ $labels.instance }}"

  - alert: CriticalMemoryUsage
    expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100 > 95
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "Critical memory usage detected"
      description: "Memory usage is above 95% for more than 2 minutes on {{ $labels.instance }}"

  - alert: HighDiskUsage
    expr: (node_filesystem_size_bytes{fstype!="tmpfs"} - node_filesystem_free_bytes{fstype!="tmpfs"}) / node_filesystem_size_bytes{fstype!="tmpfs"} * 100 > 85
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High disk usage detected"
      description: "Disk usage is above 85% for more than 5 minutes on {{ $labels.instance }} filesystem {{ $labels.mountpoint }}"

  - alert: CriticalDiskUsage
    expr: (node_filesystem_size_bytes{fstype!="tmpfs"} - node_filesystem_free_bytes{fstype!="tmpfs"}) / node_filesystem_size_bytes{fstype!="tmpfs"} * 100 > 95
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "Critical disk usage detected"
      description: "Disk usage is above 95% for more than 2 minutes on {{ $labels.instance }} filesystem {{ $labels.mountpoint }}"

- name: nordlayer_application
  rules:
  - alert: HighErrorRate
    expr: rate(http_requests_total{status_code=~"5.."}[5m]) / rate(http_requests_total[5m]) * 100 > 5
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High error rate detected"
      description: "Error rate is above 5% for more than 5 minutes on {{ $labels.instance }}"

  - alert: CriticalErrorRate
    expr: rate(http_requests_total{status_code=~"5.."}[5m]) / rate(http_requests_total[5m]) * 100 > 10
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "Critical error rate detected"
      description: "Error rate is above 10% for more than 2 minutes on {{ $labels.instance }}"

  - alert: HighResponseTime
    expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High response time detected"
      description: "95th percentile response time is above 2 seconds for more than 5 minutes on {{ $labels.instance }}"

  - alert: CriticalResponseTime
    expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 5
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "Critical response time detected"
      description: "95th percentile response time is above 5 seconds for more than 2 minutes on {{ $labels.instance }}"

  - alert: ServiceDown
    expr: up == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "Service is down"
      description: "{{ $labels.job }} service is down on {{ $labels.instance }}"

  - alert: TooManyActiveRequests
    expr: http_requests_active > 100
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Too many active requests"
      description: "More than 100 active requests for more than 5 minutes on {{ $labels.instance }}"

- name: nordlayer_telegram_bot
  rules:
  - alert: TelegramBotDown
    expr: up{job="nordlayer-telegram-bot"} == 0
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "Telegram bot is down"
      description: "NordLayer Telegram bot has been down for more than 2 minutes"

  - alert: HighBotErrorRate
    expr: rate(telegram_bot_errors_total[5m]) / rate(telegram_bot_messages_total[5m]) * 100 > 10
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High Telegram bot error rate"
      description: "Telegram bot error rate is above 10% for more than 5 minutes"

- name: nordlayer_business
  rules:
  - alert: NoOrdersReceived
    expr: increase(orders_created_total[1h]) == 0
    for: 2h
    labels:
      severity: warning
    annotations:
      summary: "No orders received"
      description: "No orders have been received in the last 2 hours"

  - alert: HighOrderFailureRate
    expr: rate(orders_failed_total[5m]) / rate(orders_total[5m]) * 100 > 5
    for: 10m
    labels:
      severity: warning
    annotations:
      summary: "High order failure rate"
      description: "Order failure rate is above 5% for more than 10 minutes"