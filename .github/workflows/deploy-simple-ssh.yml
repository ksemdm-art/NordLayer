name: Simple Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          set -e
          echo "üöÄ Starting deployment..."
          
          # –°–æ–∑–¥–∞–µ–º –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞
          sudo mkdir -p /opt/printing-platform
          sudo chown deploy:deploy /opt/printing-platform
          cd /opt/printing-platform
          
          # –ö–ª–æ–Ω–∏—Ä—É–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
          if [ -d ".git" ]; then
            echo "üì• Updating existing repository..."
            git fetch origin
            git reset --hard origin/main
            git pull origin main
          else
            echo "üì• Cloning repository..."
            git clone https://github.com/ksemdm-art/NordLayer.git .
          fi
          
          echo "‚öôÔ∏è Setting up environment..."
          cp .env.production.template .env
          
          # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ø–∞—Ä–æ–ª–∏
          SECRET_KEY=$(openssl rand -hex 32)
          DB_PASSWORD=$(openssl rand -base64 16 | tr -d "=+/" | cut -c1-16)
          
          # –û–±–Ω–æ–≤–ª—è–µ–º .env —Ñ–∞–π–ª
          sed -i "s/CHANGE_THIS_TO_SECURE_RANDOM_STRING_64_CHARS_LONG_PLEASE/$SECRET_KEY/" .env
          sed -i "s/CHANGE_THIS_TO_SECURE_PASSWORD/$DB_PASSWORD/" .env
          
          echo "üõë Stopping old containers..."
          sudo docker-compose -f docker-compose.prod.yml down || true
          
          echo "üê≥ Building and starting containers..."
          sudo docker-compose -f docker-compose.prod.yml up -d --build
          
          echo "‚è≥ Waiting for services to start..."
          sleep 45
          
          echo "üìä Container status:"
          sudo docker-compose -f docker-compose.prod.yml ps
          
          echo "‚úÖ Deployment completed successfully!"